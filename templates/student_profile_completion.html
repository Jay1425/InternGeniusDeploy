{% extends "base.html" %}

{% block title %}Complete Your Profile - InternGenius{% endblock %}

{% block custom_css %}
<style>
    /* Align look-and-feel with registration page using existing theme colors */
    :root {
        /* Ensure theme colors are available */
        --govt-primary: #1e40af;
        --govt-secondary: #3b82f6;
        --govt-saffron: #FF9933;
        --govt-white: #FFFFFF;
        --govt-green: #138808;
        --govt-dark: #333333;
        --govt-light: #f8f9fa;
        --govt-info: #0369a1;
        --govt-success: #059669;
        --govt-warning: #d97706;
        --govt-danger: #dc2626;
        --border-color: #e5e7eb;
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }
    
    body {
        background-color: var(--govt-light) !important;
        color: var(--govt-dark) !important;
        font-family: 'Roboto', sans-serif;
    }
    
    .container {
        background-color: transparent !important;
    }
    
    /* Primary button styling */
    .btn-primary {
        background-color: var(--govt-primary) !important;
        border-color: var(--govt-primary) !important;
        color: white !important;
    }
    
    .btn-primary:hover {
        background-color: #1e3a8a !important;
        border-color: #1e3a8a !important;
    }
    
    /* Card styling */
    .card {
        background-color: white !important;
        border: 1px solid var(--border-color) !important;
        box-shadow: var(--shadow-lg) !important;
    }
    
    .card-header.bg-primary {
        background-color: var(--govt-primary) !important;
        border-bottom: 3px solid #1e3a8a !important;
        color: white !important;
    }
    
    /* Form styling */
    .form-control, .form-select {
        background-color: white !important;
        border: 1px solid #d1d5db !important;
        color: var(--govt-dark) !important;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: var(--govt-primary) !important;
        box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.15) !important;
    }
    
    .form-label {
        color: var(--govt-dark) !important;
        font-weight: 600;
    }
    
    /* Alert styling */
    .alert-info {
        background-color: #eff6ff !important;
        border-color: var(--govt-info) !important;
        color: #0f4e78 !important;
        border-left: 4px solid var(--govt-primary) !important;
    }
    
    /* Section titles */
    .profile-section-title {
        color: var(--govt-primary) !important;
        font-weight: 700;
        font-size: 1.25rem;
        margin: 1.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: .5rem;
    }
    
    .text-primary {
        color: var(--govt-primary) !important;
    }
    .profile-completion-container {
        max-width: 1000px;
        margin: 2rem auto 3rem;
    }
    .profile-completion-card {
        border-radius: 8px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
        position: relative;
        overflow: hidden;
    }
    .profile-completion-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--govt-primary);
    }
    .profile-section-title {
        color: var(--govt-primary);
        font-weight: 700;
        font-size: 1.25rem;
        margin: 1.5rem 0 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: .5rem;
    }
    .card-header.bg-primary {
        background-color: var(--govt-primary) !important;
        border-bottom: 3px solid #084785;
    }
    .form-label { font-weight: 600; }
    .btn-primary { background-color: var(--govt-primary); border-color: var(--govt-primary); }
    .btn-primary:hover { background-color: #084785; border-color: #084785; }
    .alert-info { border-left: 4px solid var(--govt-primary); }
    .needs-validation .form-control:focus, .needs-validation .form-select:focus {
        box-shadow: 0 0 0 0.2rem rgba(9,83,154,0.15);
        border-color: var(--govt-primary);
    }
    @media (max-width: 768px) { .profile-completion-container { margin-top: 1rem; } }
    /* End minimal theming */
    
    /* Hide any accidental direct token text if present */
    .csrf-token-text { display: none; }
  </style>
{% endblock %}

{% block content %}
<div class="container profile-completion-container">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card shadow profile-completion-card">
                <div class="card-header bg-primary text-white">
                    <h3 class="card-title mb-0">
                        <i class="fa-solid fa-user-pen me-2"></i>
                        Complete Your Profile
                    </h3>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fa-solid fa-circle-info me-2"></i>
                        Complete your profile to start applying for internships!
                    </div>

                    <!-- Debug Info (remove in production) -->
                    {% if form_values %}
                    <div class="alert alert-secondary small" style="display: none;" id="debug-info">
                        <strong>Debug:</strong> Form values loaded: {{ form_values|length }} fields
                        <br>Populated fields: {{ (form_values.values()|select|list)|length }}
                    </div>
                    {% endif %}

                    <form method="POST" action="{{ url_for('complete_student_profile') }}" class="needs-validation" novalidate>
                        {# Hidden CSRF token only; do not render the token visibly #}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <!-- Personal Information -->
                        <h5 class="profile-section-title">
                            <i class="fa-solid fa-user"></i>
                            Personal Information
                        </h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="phone" class="form-label">Phone Number *</label>
                    <input type="tel" class="form-control" id="phone" name="phone" required 
                        pattern="[0-9]{10}" placeholder="10-digit mobile number" value="{{ form_values.phone or '' }}">
                                <div class="invalid-feedback">
                                    Please provide a valid 10-digit phone number.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="date_of_birth" class="form-label">Date of Birth *</label>
                                <input type="date" class="form-control" id="date_of_birth" name="date_of_birth" required value="{{ form_values.date_of_birth or '' }}">
                                <div class="invalid-feedback">
                                    Please provide your date of birth.
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="gender" class="form-label">Gender *</label>
                                <select class="form-select" id="gender" name="gender" required data-selected="{{ form_values.gender or '' }}">
                                    <option value="">Select Gender</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                    <option value="Other">Other</option>
                                    <option value="Prefer not to say">Prefer not to say</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select your gender.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="nationality" class="form-label">Nationality</label>
                    <input type="text" class="form-control" id="nationality" name="nationality" 
                        value="{{ form_values.nationality or 'Indian' }}" placeholder="Indian">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="category" class="form-label">Category</label>
                                <select class="form-select" id="category" name="category" data-selected="{{ form_values.category or '' }}">
                                    <option value="">Select Category</option>
                                    <option value="General">General</option>
                                    <option value="OBC">OBC</option>
                                    <option value="SC">SC</option>
                                    <option value="ST">ST</option>
                                    <option value="EWS">EWS</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="aadhaar" class="form-label">Aadhaar Number</label>
                    <input type="text" class="form-control" id="aadhaar" name="aadhaar" 
                        placeholder="12-digit Aadhaar number" maxlength="12" pattern="[0-9]{12}" value="{{ form_values.aadhaar or '' }}">
                                <small class="form-text text-muted">Optional - helps in verification process</small>
                            </div>
                        </div>

                        <!-- Address Information -->
                        <h5 class="profile-section-title">
                            <i class="fa-solid fa-location-dot"></i>
                            Address Information
                        </h5>

                        <div class="mb-3">
                            <label for="address_line1" class="form-label">Address Line 1 *</label>
                <input type="text" class="form-control" id="address_line1" name="address_line1" required
                    placeholder="House/Flat No., Building Name" value="{{ form_values.address_line1 or '' }}">
                            <div class="invalid-feedback">
                                Please provide your address.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="address_line2" class="form-label">Address Line 2</label>
                <input type="text" class="form-control" id="address_line2" name="address_line2"
                    placeholder="Street, Landmark" value="{{ form_values.address_line2 or '' }}">
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label for="city" class="form-label">City *</label>
                                <input type="text" class="form-control" id="city" name="city" required value="{{ form_values.city or '' }}">
                                <div class="invalid-feedback">
                                    Please provide your city.
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="state" class="form-label">State *</label>
                                <input type="text" class="form-control" id="state" name="state" required value="{{ form_values.state or '' }}">
                                <div class="invalid-feedback">
                                    Please provide your state.
                                </div>
                            </div>
                            <div class="col-md-4">
                                <label for="pincode" class="form-label">Pin Code *</label>
                    <input type="text" class="form-control" id="pincode" name="pincode" required
                        pattern="[0-9]{6}" placeholder="6-digit pin code" value="{{ form_values.pincode or '' }}">
                                <div class="invalid-feedback">
                                    Please provide a valid 6-digit pin code.
                                </div>
                            </div>
                        </div>

                        <!-- Educational Information -->
                        <h5 class="profile-section-title">
                            <i class="fa-solid fa-graduation-cap"></i>
                            Educational Information
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="university" class="form-label">University/College *</label>
                                <input type="text" class="form-control" id="university" name="university" required value="{{ form_values.university or '' }}">
                                <div class="invalid-feedback">
                                    Please provide your university/college name.
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label for="degree" class="form-label">Degree *</label>
                    <input type="text" class="form-control" id="degree" name="degree" required
                        placeholder="e.g., B.Tech, MBA, BCA" value="{{ form_values.degree or '' }}">
                                <div class="invalid-feedback">
                                    Please provide your degree.
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="specialization" class="form-label">Specialization</label>
                    <input type="text" class="form-control" id="specialization" name="specialization"
                        placeholder="e.g., Computer Science, Marketing" value="{{ form_values.specialization or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="graduation_year" class="form-label">Expected Graduation Year *</label>
                                <select class="form-select" id="graduation_year" name="graduation_year" required data-selected="{{ form_values.graduation_year or '' }}">
                                    <option value="">Select Year</option>
                                    <option value="2024">2024</option>
                                    <option value="2025">2025</option>
                                    <option value="2026">2026</option>
                                    <option value="2027">2027</option>
                                    <option value="2028">2028</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select your graduation year.
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="cgpa" class="form-label">CGPA/Percentage</label>
                    <input type="text" class="form-control" id="cgpa" name="cgpa"
                        placeholder="e.g., 8.5 or 85%" value="{{ form_values.cgpa or '' }}">
                            </div>
                        </div>

                        <!-- Skills and Preferences -->
                        <h5 class="profile-section-title">
                            <i class="fa-solid fa-gears"></i>
                            Skills & Preferences
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="technical_skills" class="form-label">Technical Skills</label>
                                <textarea class="form-control" id="technical_skills" name="technical_skills" rows="3"
                                          placeholder="List your technical skills (e.g., Python, Java, HTML/CSS, Data Analysis)">{{ form_values.technical_skills or '' }}</textarea>
                            </div>
                            <div class="col-md-6">
                                <label for="soft_skills" class="form-label">Soft Skills</label>
                                <textarea class="form-control" id="soft_skills" name="soft_skills" rows="3"
                                          placeholder="List your soft skills (e.g., Communication, Leadership, Problem Solving)">{{ form_values.soft_skills or '' }}</textarea>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="languages" class="form-label">Languages Known</label>
                    <input type="text" class="form-control" id="languages" name="languages"
                        placeholder="e.g., English, Hindi, Gujarati" value="{{ form_values.languages or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="interests" class="form-label">Areas of Interest *</label>
                                <textarea class="form-control" id="interests" name="interests" rows="2" required
                                          placeholder="Areas you're interested to work in (e.g., Web Development, Machine Learning, Digital Marketing)">{{ form_values.interests or '' }}</textarea>
                                <div class="invalid-feedback">
                                    Please provide your areas of interest.
                                </div>
                            </div>
                        </div>

                        <!-- Internship Preferences -->
                        <h5 class="profile-section-title">
                            <i class="fa-solid fa-briefcase"></i>
                            Internship Preferences
                        </h5>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="preferred_location" class="form-label">Preferred Location</label>
                    <input type="text" class="form-control" id="preferred_location" name="preferred_location"
                        placeholder="e.g., Mumbai, Bangalore, Remote" value="{{ form_values.preferred_location or '' }}">
                            </div>
                            <div class="col-md-6">
                                <label for="work_mode" class="form-label">Preferred Work Mode</label>
                                <select class="form-select" id="work_mode" name="work_mode" data-selected="{{ form_values.work_mode or '' }}">
                                    <option value="">Select Work Mode</option>
                                    <option value="Remote">Remote</option>
                                    <option value="In-person">In-person</option>
                                    <option value="Hybrid">Hybrid</option>
                                    <option value="Flexible">Flexible</option>
                                </select>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="internship_duration" class="form-label">Preferred Duration</label>
                                <select class="form-select" id="internship_duration" name="internship_duration" data-selected="{{ form_values.internship_duration or '' }}">
                                    <option value="">Select Duration</option>
                                    <option value="1-3 months">1-3 months</option>
                                    <option value="3-6 months">3-6 months</option>
                                    <option value="6-12 months">6-12 months</option>
                                    <option value="Flexible">Flexible</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="expected_stipend" class="form-label">Expected Stipend (₹/month)</label>
                    <input type="number" class="form-control" id="expected_stipend" name="expected_stipend"
                        placeholder="e.g., 10000" value="{{ form_values.expected_stipend or '' }}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="availability" class="form-label">Availability</label>
                            <select class="form-select" id="availability" name="availability" data-selected="{{ form_values.availability or '' }}">
                                <option value="">Select Availability</option>
                                <option value="Immediately">Immediately</option>
                                <option value="Within 1 month">Within 1 month</option>
                                <option value="Within 2-3 months">Within 2-3 months</option>
                                <option value="After completion of semester">After completion of semester</option>
                            </select>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <button type="button" class="btn btn-secondary me-md-2" onclick="history.back()">
                                <i class="fa-solid fa-arrow-left me-2"></i>Back
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fa-solid fa-check me-2"></i>Complete Profile
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Ensure prefilled select values are applied as soon as DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    console.log('🔄 Profile completion form loading...');
    
    // Show debug info temporarily
    const debugInfo = document.getElementById('debug-info');
    if (debugInfo) {
        debugInfo.style.display = 'block';
        setTimeout(() => debugInfo.style.display = 'none', 3000);
    }
    
    // Apply data-selected values to select elements
    document.querySelectorAll('select[data-selected]').forEach(function(sel) {
        var val = sel.getAttribute('data-selected');
        console.log(`🔧 Setting ${sel.id} to: "${val}"`);
        if (val) {
            sel.value = val;
            if (sel.value !== val) {
                console.warn(`❌ Failed to set ${sel.id} to "${val}". Available options:`, 
                    Array.from(sel.options).map(o => o.value));
            } else {
                console.log(`✅ Successfully set ${sel.id}`);
            }
        }
    });
    
    // Verify all form values are properly set
    document.querySelectorAll('input[value], textarea').forEach(function(inp) {
        if (inp.value) {
            console.log(`📝 ${inp.name || inp.id}: "${inp.value}"`);
        }
    });
    
    console.log('✅ Profile completion form loaded');
});

// Form validation
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Auto-format phone number
document.getElementById('phone').addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
    if (this.value.length > 10) this.value = this.value.slice(0, 10);
});

// Auto-format pincode
document.getElementById('pincode').addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
    if (this.value.length > 6) this.value = this.value.slice(0, 6);
});

// Auto-format Aadhaar number
document.getElementById('aadhaar').addEventListener('input', function() {
    this.value = this.value.replace(/[^0-9]/g, '');
    if (this.value.length > 12) this.value = this.value.slice(0, 12);
});
</script>
{% endblock %}
